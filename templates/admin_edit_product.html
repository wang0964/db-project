{% extends "base.html" %}
{% block content %}
<h2>Edit Product</h2>
<p><a id="backLink" href="#" onclick="if(document.referrer){history.back();}else{window.location='{{ url_for('admin_products') }}';} return false;">← Back</a></p>
<form method="post">
  Title: <input type="text" name="title" value="{{ p.title }}" required><br>
  Price: <input type="number" step="0.01" name="price" value="{{ p.price }}" required><br>
  SKU: <input type="text" name="sku" value="{{ p.variants }}" required><br>
  <label><input type="checkbox" name="is_active" {% if p.status=='active' %}checked{% endif %}> Active</label><br>
  Stock: <input type="number" name="stock" min="0" value="{{ p.stock or 0 }}"><br>

<!-- --- Attributes Editor (start) --- -->
  <div id="attr-editor" style="margin:10px 0 16px">
    <div style="font-weight:600; margin-bottom:6px">
      Add New Attributes
    </div>

    <div id="attrs-list"></div>

    <button type="button" id="add-attr">+ Add attribute</button>
    <small style="display:block; color:#666; margin-top:6px">  </small>
  </div>
  <!-- --- Attributes Editor (end) --- -->

  Categories (multi-select):<br>
  {% set selected = (p.categoryIds or []) | map('string') | list %}
  {% for c in categories %}
  <label style="margin-right: 16px"
    ><input
      type="checkbox"
      name="categories"
      class="cat"
      value="{{ c._id|string }}"                      
      data-parent="{{ (c.parentId|string) if c.parentId else '' }}"
      {% if (c._id|string) in selected %}checked{% endif %}
    />
    {{ c.path }}</label
  >
  {% endfor %}
  <br><button type="submit">Save Changes</button>
</form>

<h3>Images</h3>
<div>
  {% for pair in img_pairs %}
    <div style="display:inline-block;margin:6px;text-align:center;">
      <img src="{{ pair.url }}" style="width:120px;height:120px;object-fit:cover;border:1px solid #ddd;border-radius:6px;display:block;">
      <form method="post" action="{{ url_for('delete_image', product_id=p._id) }}">
        <input type="hidden" name="img" value="{{ pair.id }}">
        <button type="submit" onclick="return confirm('Delete this image?')">Delete</button>
      </form>
    </div>
  {% endfor %}
</div>

<form method="post" action="{{ url_for('upload_images', product_id=p._id) }}" enctype="multipart/form-data">
  <input type="file" name="images" multiple>
  <button type="submit">Upload Images</button>
</form>


<script>
  (function () {
    const boxes = [...document.querySelectorAll('input.cat')];


    const byId = Object.create(null);
    const childrenOf = Object.create(null);
    for (const b of boxes) {
      const id = b.value;                   
      const p  = (b.dataset.parent || '').trim();  
      byId[id] = b;
      if (!childrenOf[p]) childrenOf[p] = [];
      childrenOf[p].push(id);               
    }


    function checkAncestors(b) {
      for (let p = (b.dataset.parent || '').trim(); p && byId[p]; p = (byId[p].dataset.parent || '').trim()) {
        const par = byId[p];
        if (!par.checked) par.checked = true;
      }
    }


    function uncheckDescendants(id) {
      const children = childrenOf[id] || [];
      for (const cid of children) {
        const ch = byId[cid];
        if (ch.checked) ch.checked = false;
        uncheckDescendants(cid);   // 递归
      }
    }


    boxes.forEach(b => {
      b.addEventListener('change', () => {
        if (b.checked) {
          checkAncestors(b);            
        } else {
          uncheckDescendants(b.value);  
        }
      });
    });


    boxes.filter(b => b.checked).forEach(checkAncestors);
  })();

</script>





<script type="application/json" id="extra-attrs-data">
  {{ extra_attrs | default({}, true) | tojson | safe }}
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('attrs-list');
    const addBtn = document.getElementById('add-attr');

    function addAttrRow(key = '', val = '') {
      const row = document.createElement('div');
      row.className = 'attr-row';
      row.style.margin = '4px 0';
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.innerHTML = `
        <input type="text" name="attr_name[]" placeholder="Key (e.g. attributes.color)"
               style="width:240px" value="${(key ?? '').toString().replaceAll('"','&quot;')}">
        <input type="text" name="attr_value[]" placeholder='Value (e.g. "red" or 19.99)'
               style="width:240px" value="${(val ?? '').toString().replaceAll('"','&quot;')}">
        <button type="button" class="rm" title="Remove">×</button>
      `;
      row.querySelector('.rm').addEventListener('click', () => row.remove());
      list.appendChild(row);
    }

    addBtn?.addEventListener('click', () => addAttrRow());

    const prefill = JSON.parse(document.getElementById('extra-attrs-data').textContent || '{}');
    const entries = Object.entries(prefill);
    if (entries.length) {
      entries.forEach(([k, v]) => addAttrRow(k, v));
    } else {
      addAttrRow();
    }
  });
</script>






{% endblock %}
