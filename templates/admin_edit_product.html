{% extends "base.html" %}
{% block content %}
<h2>Edit Product</h2>
<form method="post">
  Title: <input type="text" name="title" value="{{ p.title }}" required><br>
  Price: <input type="number" step="0.01" name="price" value="{{ p.price }}" required><br>
  SKU: <input type="text" name="sku" value="{{ p.variants[0].sku if p.variants else '' }}" required><br>
  <label><input type="checkbox" name="is_active" {% if p.status=='active' %}checked{% endif %}> Active</label><br>
  Stock: <input type="number" name="stock" min="0" value="{{ p.stock or 0 }}"><br>
  Categories (multi-select):<br>
  {% set selected = (p.categoryIds or []) | map('string') | list %}
  {% for c in categories %}
  <label style="margin-right: 16px"
    ><input
      type="checkbox"
      name="categories"
      class="cat"
      value="{{ c._id|string }}"                      
      data-parent="{{ (c.parentId|string) if c.parentId else '' }}"
      {% if (c._id|string) in selected %}checked{% endif %}
    />
    {{ c.path }}</label
  >
  {% endfor %}
  <br><button type="submit">Save Changes</button>
</form>

<h3>Images</h3>
<div>
  {% for pair in img_pairs %}
    <div style="display:inline-block;margin:6px;text-align:center;">
      <img src="{{ pair.url }}" style="width:120px;height:120px;object-fit:cover;border:1px solid #ddd;border-radius:6px;display:block;">
      <form method="post" action="{{ url_for('delete_image', product_id=p._id) }}">
        <input type="hidden" name="img" value="{{ pair.id }}">
        <button type="submit" onclick="return confirm('Delete this image?')">Delete</button>
      </form>
    </div>
  {% endfor %}
</div>

<form method="post" action="{{ url_for('upload_images', product_id=p._id) }}" enctype="multipart/form-data">
  <input type="file" name="images" multiple>
  <button type="submit">Upload Images</button>
</form>


<script>
  (function () {
    const boxes = [...document.querySelectorAll('input.cat')];


    const byId = Object.create(null);
    const childrenOf = Object.create(null);
    for (const b of boxes) {
      const id = b.value;                   
      const p  = (b.dataset.parent || '').trim();  
      byId[id] = b;
      if (!childrenOf[p]) childrenOf[p] = [];
      childrenOf[p].push(id);               
    }


    function checkAncestors(b) {
      for (let p = (b.dataset.parent || '').trim(); p && byId[p]; p = (byId[p].dataset.parent || '').trim()) {
        const par = byId[p];
        if (!par.checked) par.checked = true;
      }
    }


    function uncheckDescendants(id) {
      const children = childrenOf[id] || [];
      for (const cid of children) {
        const ch = byId[cid];
        if (ch.checked) ch.checked = false;
        uncheckDescendants(cid);   // 递归
      }
    }


    boxes.forEach(b => {
      b.addEventListener('change', () => {
        if (b.checked) {
          checkAncestors(b);            
        } else {
          uncheckDescendants(b.value);  
        }
      });
    });


    boxes.filter(b => b.checked).forEach(checkAncestors);
  })();
</script>



{% endblock %}
