{% extends "base.html" %}
{% block content %}
<h2>{{ p.title }}</h2>
<p><a id="backLink" href="#" onclick="if(document.referrer){history.back();}else{window.location='{{ url_for('index') }}';} return false;">← Back</a></p>
<div style="display:flex;gap:24px;align-items:flex-start;">
  <div class="viewer">
    <img id="mainImg" src="{{ imgs[0] if imgs else '' }}" style="width:360px;height:480px;object-fit:cover;border-radius:8px;background:#f5f5f5;">
    {% if imgs|length > 1 %}
    <button class="prev" onclick="prevImg()" type="button">❮</button>
    <button class="next" onclick="nextImg()" type="button">❯</button>
    {% endif %}
    <div style="margin-top:8px;">
      {% for u in imgs %}
        <img src="{{ u }}" onclick="setImg({{ loop.index0 }})" style="width:54px;height:54px;object-fit:cover;margin-right:8px;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
      {% endfor %}
    </div>
  </div>

  <div>
    <p>Price: <strong>${{ "%.2f"|format(p.price or 0) }}</strong></p>
    <p>Categories: {{ categories|join(", ") }}</p>
    <p>Stock: <strong>{{ p.stock or 0 }}</strong></p>

    {% for k, v in extra_attrs.items() %}
      <p>{{ k }}: {{ v }}</p>
    {% endfor %}

    {% if current_user.is_authenticated %}
    <form action="{{ url_for('add_to_cart') }}" method="post" style="margin-top:10px;">
      <input type="hidden" name="product_id" value="{{ p._id }}">
      Qty: <input type="number" name="qty" value="1" min="1" style="width:80px;">
      {% if (p.stock or 0) > 0 %}
        <button type="submit">Add to Cart</button>
      {% else %}
        <button type="button" disabled>Sold out</button>
      {% endif %}
    </form>
    {% else %}
      <p><a href="{{ url_for('login') }}?next={{ request.full_path|urlencode }}">Please sign in to add to cart</a></p>
    {% endif %}
  </div>
</div>
<script>
  const imgs = {{ imgs|tojson }};
  let idx = 0;
  function setImg(i){ idx=i; document.getElementById('mainImg').src = imgs[idx] || ''; }
  function prevImg(){ if(!imgs.length) return; idx=(idx-1+imgs.length)%imgs.length; setImg(idx); }
  function nextImg(){ if(!imgs.length) return; idx=(idx+1)%imgs.length; setImg(idx); }
</script>
{% endblock %}
